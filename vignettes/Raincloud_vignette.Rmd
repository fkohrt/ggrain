---
title: "Raincloud Plots"
author:
  - name: "Dr. Nicholas Judd"
    url: https://njudd.com
    affiliation: Donders Institute
    affiliation_url: https://www.ru.nl/donders/
    orcid_id: 0000-0002-0196-9871
  - name: "Dr. Rogier Kievit"
    url: https://www.rogierkievit.com/
    affiliation: Donders Institute
    affiliation_url: https://www.ru.nl/donders/
    orcid_id: 0000-0003-0700-4568
  - name: "Jordy van Langen"
    url: https://github.com/jorvlan
    affiliation: Donders Institute
    affiliation_url: https://www.ru.nl/donders/
    orcid_id: 0000-0003-2504-2381
output:
  distill::distill_article:
    code_folding:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# http://trinker.github.io/pacman/vignettes/Introduction_to_pacman.html
if (!require(pacman)) {
    install.packages("pacman")
}

pacman::p_load(ggplot, rlang, grid, ggpp, lavaan, gghalves, patchwork, remotes)

remotes::install_github('njudd/ggrain')

library(ggrain)

```

## geom_rain()

* handles as many rainclouds as you wish and can overlap them by a group
* connects observations longitudinally with lines using `id.long.var` argument
* colors dots by a covariate using the `cov` argument
* handles likert data by adding y-jittering with `likert = TRUE`


```{r making dataset}

aging <- Demo.growth[,1:4]
aging$id <- as.factor(as.character(rep(1:dim(aging)[1])))
aging <- reshape2::melt(aging, id.vars = "id")
aging$value_round <- round(aging$value,1)
colnames(aging)[2] <- "time"

aging$covariate <- -aging$value*2

aging$group <- c(rep("old", 200), rep("young", 200), rep("old", 200), rep("young", 200),
                 rep("old", 200), rep("young", 200), rep("old", 200), rep("young", 200))

aging$value[aging$group == "young"] <- aging$value[aging$group == "young"] + 1
aging$value[aging$group == "old" & aging$time == "t2"] <- aging$value[aging$group == "old" & aging$time == "t2"] -2

# aging2 <- aging |>  dplyr::filter(time %in% c("t1", "t2"))
# 
# aging2$group <- c(rep("old", 200), rep("young", 200), rep("old", 200), rep("young", 200))
# aging2$value[aging2$group == "young"] <- aging2$value[aging2$group == "young"] + 1
# aging2$value[aging2$group == "old" & aging2$time == "t2"] <- aging2$value[aging2$group == "old" & aging2$time == "t2"] -2
# 
# 
# aging2_n40 <- aging2 |> dplyr::filter(id %in% c(as.character(1:10), as.character(200:210), as.character(400:410), as.character(600:610)))

```

```{r showing datasets, echo = T}

# add some fancy interactive dataset table here

head(aging)

```


```{r most basic raincloud possible, echo = T}

ggplot(aging, aes(1, value)) +
  geom_rain() +
  theme_classic() +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank())
```
Let's see what is happening over the four time points

```{r rainclouds by time, echo = T}

ggplot(aging, aes(time, value, fill = time)) +
  geom_rain(alpha = .3) +
  theme_classic()
```

Let's color the dots by time, we need to add a `boxplot.args` for color to be black as this makes the median and IQR visable along with re-adding the default for no outliers.


```{r rainclouds by time colored, echo = T}

ggplot(aging, aes(time, value, fill = time, color = time)) +
  geom_rain(alpha = .3,
            boxplot.args = list(color = "black", outlier.shape = NA)) +
  theme_classic()
```

Instead of coloring the dots by time, lets see how our two groups are doing (old & young people).
We can do this by adding them as a covariate with the `cov` arg.

```{r rainclouds by time colored by group, echo = T}

ggplot(aging, aes(time, value, fill = time)) +
  geom_rain(alpha = .3,
            cov = "group") +
  theme_classic()
```


These are distinct groups it would be much more informative to plot them separately!

```{r rainclouds by time by group, echo = T}

ggplot(aging, aes(time, value, fill = group)) +
  geom_rain(alpha = .3) +
  theme_classic()
```

We can't really see the boxplots so lets dodge them while also nudging, we can do this with the boxplot position arg `boxplot.args.pos`. Remember to readd the defaults if you would like to keep them!

```{r rainclouds by time by group dodged, echo = T}

ggplot(aging, aes(time, value, fill = group)) +
  geom_rain(alpha = .3, 
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .1), width = 0.05
            )) +
  theme_classic()
```

Lets flip them, while keeping the boxplots dodging.

```{r rainclouds by time by group dodged left, echo = T}

ggplot(aging, aes(time, value, fill = group)) +
  geom_rain(alpha = .3, rain.side = 'l',
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .1), width = 0.05
            )) +
  theme_classic()
```
As you can see the `rain.side` arg negates the x position argument you give `geom_rain`.

Lets connect the individuals across time! We can do this with `id.long.var`

```{r rainclouds by time by group connected, echo = T}

ggplot(aging, aes(time, value, fill = group)) +
  geom_rain(id.long.var = 'id',
            alpha = .3, rain.side = 'l',
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .1), width = 0.05
            )) +
  theme_classic()
```


We can make some aesthetic changes to make the violins and box plot's more visible. We will do this with `boxplot.args`, `violin.args`, `line.args` and `point.args`.


```{r rainclouds by time by group connected better, echo = T}

ggplot(aging, aes(time, value, fill = group)) +
  geom_rain(id.long.var = 'id', rain.side = 'l',
            boxplot.args = list(alpha = .8, outlier.shape = NA),
            violin.args = list(alpha = .8, color = NA),
            point.args = list(alpha = .2),
            line.args = list(alpha = .05),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .1), width = 0.05
            )) +
  theme_classic() +
  scale_fill_manual(values=c("dodgerblue", "darkorange"))
```


Let's color the dots by a covariate and use the viridis color palette!

```{r rainclouds by time by group connected better viridis cov, echo = T}

ggplot(aging, aes(time, value, fill = group)) +
  geom_rain(cov = 'covariate', 
            id.long.var = 'id', rain.side = 'l',
            boxplot.args = list(alpha = .8, outlier.shape = NA),
            violin.args = list(alpha = .8, color = NA),
            point.args = list(alpha = .5),
            line.args = list(alpha = .05),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .1), width = 0.05
            )) +
  theme_classic() +
  scale_fill_manual(values=c("dodgerblue", "darkorange")) +
  scale_color_viridis_c()
```

### Inference (incomplete) waiting for flanking

Let's take a step back and look if the groups are significantly different in the first two time points!

```{r rainclouds aging two timepoints, echo = T}

aging_subset <- aging[aging$time %in% c('t1', 't2'),]

ggplot(aging_subset, aes(time, value, fill = group)) +
  geom_rain(alpha = .5, rain.side = 'f', id.long.var = 'id') +
  theme_classic() +
  scale_fill_manual(values=c("dodgerblue", "darkorange"))
```

```{r rainclouds aging two timepoints inference, echo = T}

ggplot(aging_subset, aes(time, value, fill = group)) +
  geom_rain(alpha = .5, rain.side = 'f') +
  theme_classic() +
  stat_summary(fun = median, geom = "line", aes(group = group, color = group)) +
    stat_summary(fun = median, geom = "point",
               aes(group = group, color = group)) +
    scale_fill_manual(values=c("dodgerblue", "darkorange")) +
    scale_colour_manual(values = c("dodgerblue", "darkorange"))



```









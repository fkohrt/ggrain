---
title: "Raincloud Plots with the ggrain package"
author: Nicholas Judd, Jordy van Langen & Rogier Kievit
  # - name: "Dr. Nicholas Judd"
  #   url: https://njudd.com
  #   affiliation: Donders Institute for brain, cognition and behaviour
  #   affiliation_url: https://www.ru.nl/donders/
  #   orcid_id: 0000-0002-0196-9871
  # - name: "Dr. Rogier Kievit"
  #   url: https://www.rogierkievit.com/
  #   affiliation: Donders Institute for brain, cognition and behaviour
  #   affiliation_url: https://www.ru.nl/donders/
  #   orcid_id: 0000-0003-0700-4568
  # - name: "Jordy van Langen"
  #   url: https://github.com/jorvlan
  #   affiliation: Donders Institute for brain, cognition and behaviour
  #   affiliation_url: https://www.ru.nl/donders/
  #   orcid_id: 0000-0003-2504-2381
output: pdf_document
# output:
#   distill::distill_article:
#     code_folding:
#     toc: true
#     toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
# http://trinker.github.io/pacman/vignettes/Introduction_to_pacman.html
if (!require(pacman)) {
    install.packages("pacman")
}

pacman::p_load(ggplot, rlang, grid, ggpp, lavaan, gghalves, patchwork, remotes, DT)

remotes::install_github('njudd/ggrain')

library(ggrain)
```

## The `geom_rain()` function

* handles as many rainclouds as you wish and can overlap them by a group
* connects within-subject observations longitudinally with lines using `id.long.var` argument
* colors dots by a covariate using the `cov` argument
* handles likert data by adding y-jittering with `likert = TRUE`
* changes orientation with `+ coord_flip()`

All individual elements of the plots can be edited, these are split into aesthetic and positioning arguments that are supplied by lists. For example the boxplot's can be edited with `boxplot.args` and `boxplot.args.pos`, yet the others can also be edited by substituting for their name, i.e. `point/violin/line`. When you supply a list the defaults are overwritten so you may need to re-add them. To see the defaults run `?geom_rain`.

## Introduction 
```{r making dataset}

aging <- Demo.growth[,1:4]
aging$id <- as.factor(as.character(rep(1:dim(aging)[1])))
aging <- reshape2::melt(aging, id.vars = "id")
# aging$value_round <- round(aging$value,1)
colnames(aging)[2] <- "time"

aging$covariate <- -aging$value*2

aging$group <- c(rep("old", 200), rep("young", 200), rep("old", 200), rep("young", 200),
                 rep("old", 200), rep("young", 200), rep("old", 200), rep("young", 200))

aging$value[aging$group == "young"] <- aging$value[aging$group == "young"] + 1
aging$value[aging$group == "old" & aging$time == "t2"] <- aging$value[aging$group == "old" & aging$time == "t2"] -2

# aging2 <- aging |>  dplyr::filter(time %in% c("t1", "t2"))
# 
# aging2$group <- c(rep("old", 200), rep("young", 200), rep("old", 200), rep("young", 200))
# aging2$value[aging2$group == "young"] <- aging2$value[aging2$group == "young"] + 1
# aging2$value[aging2$group == "old" & aging2$time == "t2"] <- aging2$value[aging2$group == "old" & aging2$time == "t2"] -2
# 
# 
# aging2_n40 <- aging2 |> dplyr::filter(id %in% c(as.character(1:10), as.character(200:210), as.character(400:410), as.character(600:610)))

```

We will look at some aging data that has two groups (young and old) measured four times.

```{r showing datasets, eval=FALSE}

DT::datatable(aging, rownames = F, class = 'cell-border stripe')
```


Here is our first plot that is just simply all the values in the aging data set. For the function to work the value you want to plot **must be given to the y argument** in ggplot. You can than flip the plot with `+ coord_flip()` as we demonstrate below.

\newpage
```{r most basic raincloud possible, echo = T}

ggplot(aging, aes(1, value)) +
  geom_rain() +
  theme_classic() +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

\newpage
Let's see what is happening over the four time points

```{r rainclouds by time, echo = T}

ggplot(aging, aes(time, value, fill = time)) +
  geom_rain(alpha = .5) +
  theme_classic() +
  scale_fill_brewer(palette = 'Dark2')
```


\newpage
Let's color the dots by time, we do this by adding `color = time` to ggplot. The default behavior of `geom_boxplot` is to color the lines showing the median and IQR. Therefore, we need to add a `boxplot.args` for color to be black along with re-adding the default to show no outliers.

```{r rainclouds by time colored, echo = T}

ggplot(aging, aes(time, value, fill = time, color = time)) +
  geom_rain(alpha = .3,
            boxplot.args = list(color = "black", outlier.shape = NA)) +
  theme_classic() +
  scale_fill_brewer(palette = 'Dark2') +
  scale_color_brewer(palette = 'Dark2')
```


\newpage

We can flip the plots by adding `coord_flip()`

```{r rainclouds by time flip, echo = T}

ggplot(aging, aes(time, value, fill = time)) +
  geom_rain(alpha = .5) +
  theme_classic() +
  scale_fill_brewer(palette = 'Dark2') +
  coord_flip()
```

\newpage

This plot is a bit crammed, lets spread stuff out using the `boxplot.args.pos` & `violin.args.pos` arguments.

```{r rainclouds by time flip nudged, echo = T}

ggplot(aging, aes(time, value, fill = time)) +
  geom_rain(alpha = .5, 
            boxplot.args.pos = list(
              width = 0.05, position = position_nudge(x = 0.13)),
            violin.args.pos = list(
              side = "r",
              width = 0.7, position = position_nudge(x = 0.2))) +
  theme_classic() +
  scale_fill_brewer(palette = 'Dark2') +
  coord_flip()
```

\newpage
Instead of coloring the dots by time, lets see how our two groups are doing (old & young people).
We can do this by adding them as a covariate with the `cov` argument.

```{r rainclouds by time colored by group, echo = T}

ggplot(aging, aes(time, value, fill = time)) +
  geom_rain(alpha = .3,
            cov = "group") +
  theme_classic() +
  scale_fill_brewer(palette = 'Dark2') +
  scale_color_manual(values=c("dodgerblue", "darkorange"))

```

\newpage
These are distinct groups it would be much more informative to plot them separately!

```{r rainclouds by time by group, echo = T}

ggplot(aging, aes(time, value, fill = group)) +
  geom_rain(alpha = .3) +
  theme_classic() +
  scale_fill_manual(values=c("dodgerblue", "darkorange"))

```

\newpage
We can't really see the boxplots so lets dodge them while also nudging, we can do this with the boxplot position arg `boxplot.args.pos`. Remember to readd the defaults if you would like to keep them!

```{r rainclouds by time by group dodged, echo = T}

ggplot(aging, aes(time, value, fill = group)) +
  geom_rain(alpha = .3, 
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .1), width = 0.05
            )) +
  theme_classic() +
  scale_fill_manual(values=c("dodgerblue", "darkorange"))
```

\newpage
Lets flip them, while keeping the boxplots dodging.

```{r rainclouds by time by group dodged left, echo = T}

ggplot(aging, aes(time, value, fill = group)) +
  geom_rain(alpha = .3, rain.side = 'l',
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .1), width = 0.05
            )) +
  theme_classic() +
  scale_fill_manual(values=c("dodgerblue", "darkorange"))
```

\newpage
As you can see the `rain.side` arg negates the x position argument you give `geom_rain`.

Lets connect the individuals across time! 
We can do this with `id.long.var`

```{r rainclouds by time by group connected, echo = T}

ggplot(aging, aes(time, value, fill = group)) +
  geom_rain(id.long.var = 'id',
            alpha = .3, rain.side = 'l',
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .1), width = 0.05
            )) +
  theme_classic() +
  scale_fill_manual(values=c("dodgerblue", "darkorange"))
```

\newpage
We can make some aesthetic changes to make the violins and box plot's more visible. We will do this with `boxplot.args`, `violin.args`, `line.args` and `point.args`.


```{r rainclouds by time by group connected better, echo = T}

ggplot(aging, aes(time, value, fill = group)) +
  geom_rain(id.long.var = 'id', rain.side = 'l',
            boxplot.args = list(alpha = .8, outlier.shape = NA),
            violin.args = list(alpha = .8, color = NA),
            point.args = list(alpha = .2),
            line.args = list(alpha = .05),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .1), width = 0.05
            )) +
  theme_classic() +
  scale_fill_manual(values=c("dodgerblue", "darkorange"))
```

\newpage
Let's color the dots by a covariate and use the viridis color palette!

```{r rainclouds by time by group connected better viridis cov, echo = T}

ggplot(aging, aes(time, value, fill = group)) +
  geom_rain(cov = 'covariate', 
            id.long.var = 'id', rain.side = 'l',
            boxplot.args = list(alpha = .8, outlier.shape = NA),
            violin.args = list(alpha = .8, color = NA),
            point.args = list(alpha = .5),
            line.args = list(alpha = .05),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .1), width = 0.05
            )) +
  theme_classic() +
  scale_fill_manual(values=c("dodgerblue", "darkorange")) +
  scale_color_viridis_c()
```


\newpage
### Inference with flanking

Let's take a step back and look if the groups are significantly different in the first two time points!

```{r rainclouds aging two timepoints, echo = T}

aging_subset <- aging[aging$time %in% c('t1', 't2'),]

ggplot(aging_subset, aes(time, value, fill = group)) +
  geom_rain(alpha = .5, rain.side = 'f', id.long.var = 'id') +
  theme_classic() +
  scale_fill_manual(values=c("dodgerblue", "darkorange"))
```

\newpage
We can color the lines & dots as well!

```{r rainclouds aging two timepoints dots and lines colored, echo = T}

ggplot(aging_subset, aes(time, value, fill = group, color = group)) +
  geom_rain(alpha = .5, rain.side = 'f', id.long.var = 'id') +
  theme_classic() +
  scale_fill_manual(values=c("dodgerblue", "darkorange")) +
  scale_color_manual(values=c("dodgerblue", "darkorange"))

```

\newpage

```{r rainclouds aging two timepoints inference, echo = T}

ggplot(aging_subset, aes(time, value, fill = group)) +
  geom_rain(alpha = .5, rain.side = 'f') +
  theme_classic() +
  stat_summary(fun = median, geom = "line", aes(group = group, color = group)) +
    stat_summary(fun = median, geom = "point",
               aes(group = group, color = group)) +
    scale_fill_manual(values=c("dodgerblue", "darkorange")) +
    scale_colour_manual(values = c("dodgerblue", "darkorange"))

```

\newpage

#### Advanced flanking
<br>
To do advanced flanking we need to supply positioning arguments for each element/group of the boxplot & violin.

```{r rainclouds aging 4 timepoints inference, echo = T}

ggplot(aging, aes(time, value, fill = group)) +
  geom_rain(alpha = .5, rain.side = 'f',
            boxplot.args.pos = list(width = .1,
             position = ggpp::position_dodgenudge(x = c(-.13, -.13, # t1 old, t1 young
                                                        -.13, -.13, 
                                                         .13, .13, # t3 old, t3 young
                                                         .13, .13))),
            violin.args.pos = list(width = .7,
             position = position_nudge(x = c(rep(-.2, 256*2), rep(-.2, 256*2),# t1
                                             rep(-.2, 256*2), rep(-.2, 256*2), # t2
                                             rep(.2, 256*2), rep(.2, 256*2),# t3
                                             rep(.2, 256*2), rep(.2, 256*2))))) +# t4
  theme_classic() +
  stat_summary(fun = median, geom = "line", aes(group = group, color = group)) +
    stat_summary(fun = median, geom = "point",
               aes(group = group, color = group)) +
    scale_fill_manual(values=c("dodgerblue", "darkorange")) +
    scale_colour_manual(values = c("dodgerblue", "darkorange"))

```


```{r rainclouds aging 4 timepoints inference with cov, echo = F, eval=F}

g1 <- ggplot(aging, aes(time, value, fill = group)) +
  geom_rain(alpha = .5, rain.side = 'f', cov = "covariate",
            boxplot.args.pos = list(width = .1,
                                     position = ggpp::position_dodgenudge(x = c(-.13, -.13, # t1 old, t1 young
                                                                                -.12, -.12, 
                                                                                .12, .12, # t3 old, t3 young
                                                                                .12, .12))),
            violin.args.pos = list(width = .7,
                                    position = position_nudge(x = c(rep(-.2, 256*2), rep(-.2, 256*2),# t1
                                                                    rep(-.17, 256*2), rep(-.17, 256*2), # t2
                                                                    rep(.17, 256*2), rep(.17, 256*2),# t3
                                                                    rep(.17, 256*2), rep(.17, 256*2))))) +# t4
  theme_classic() +
  scale_color_viridis_c() +
  scale_fill_manual(values=c("dodgerblue", "darkorange"))


g1 + stat_summary(data = aging, aes(time, value, group = group, color = group), fun = median, geom = "line", inherit.aes = FALSE)





  # stat_summary(data = aging, fun = median, geom = "line", aes(group = group, color = group)) +
  #   stat_summary(data = aging, fun = median, geom = "point",
  #              aes(group = group, color = group)) +
  #   scale_colour_manual(values = c("dodgerblue", "darkorange"))

```

Let's create a raincloudplot with `likert` data [IN PROGRESS]

```{r rainclouds , echo = F, eval=F}

#Create fake data
pre <- c(1,1,4,1,1,2,1,1,2,2,1,3,2,1,2,2,2,3,2,4,5,2,3,3,4,4,2,2,5,3,4,3,5,3,3,4,3,2,2,2,4,2,3,2,3,4,4,3,5,1,2,5,2,3,3,5,5,3,1,3,4,2,3,4,3,3,2,3,4,5,3,3,3,4,2,2,4,3,3,5,3,3,2,2,3,3,1,4,4,2,3,4,2,2,1,2,3,3,3,2,1,2,3,3,3,2,3,4,3,4,3,1,4,2,3,2,4,3,3,4,3,3,2,3,4,3,4,3,3,3)

post <- c(1,1,1,1,1,1,1,2,2,1,1,2,2,3,2,2,2,2,2,2,3,3,2,3,1,4,1,2,3,3,5,2,4,3,4,2,3,2,3,2,3,3,3,3,3,3,4,3,5,3,1,3,2,3,3,2,2,3,3,3,4,3,3,3,3,3,3,4,3,3,3,4,3,4,3,3,2,3,3,3,3,3,1,3,3,2,2,4,5,3,3,4,3,3,2,3,3,4,3,4,1,3,4,2,3,2,4,2,3,3,3,3,4,1,3,4,3,3,3,4,3,3,3,3,3,3,3,4,4,5)

likert_data = data.frame(pre,post)

likert_data$id <- as.factor(as.character(rep(1:dim(likert_data)[1])))
likert_data <- reshape2::melt(likert_data, id.vars = "id")
colnames(likert_data)[2] <- "time"
likert_data$covariate <- -likert_data$value*2

likert_data$group <- c(rep("old", 65), rep("young", 65), rep("old", 65), rep("young", 65))#,
                # rep("old", 65), rep("young", 200), rep("old", 200), rep("young", 200))

likert_data$value[likert_data$group == "young"] <- likert_data$value[likert_data$group == "young"] + 1
likert_data$value[likert_data$group == "old" & likert_data$time == "t2"] <- likert_data$value[likert_data$group == "old" & likert_data$time == "t2"] -2

likert_data$jit <- jitter(likert_data$value, amount = .2)


# Plot the object with `likert = TRUE`
f1 <- ggplot(likert_data, aes(time, value, fill = group, color = group)) +
  geom_rain(alpha = .5, rain.side = 'f', id.long.var = 'id', likert = T) +
  theme_classic() +
  scale_fill_manual(values=c("lightgrey", "grey")) +
  scale_colour_manual(values = c("lightgrey", "grey"))

f2 <- ggplot(likert_data) + 
 geom_bar(aes(x = time, fill = as.factor(value)), position = 'fill')+
  ylab('value')+
  xlab('time')+
  scale_y_continuous(position = 'right')+
  theme_classic()#+
  #coord_flip()

#install.packages("patchwork")
library(patchwork)

f3 <- f1 + f2
f3
```
